<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ... existing styles remain the same ... */
  </style>
  <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>
  <script>
    // ... existing video-handler component remains the same ...

    class VideoLoader {
      // ... existing VideoLoader class remains the same ...
    }

    class ARExperience {
      constructor() {
        this.loadingText = document.getElementById("loading-text");
        this.errorMessage = document.getElementById("error-message");
        this.loadingScreen = document.getElementById("loading-screen");
        this.video1 = document.getElementById("vid1");
        this.video2 = document.getElementById("vid2");
        this.currentVideo = null;
        this.currentPlane = null;
        this.targetDetected = false;
        this.videoPlaying = false;
        this.arInitialized = false;

        this.init();
      }

      async init() {
        try {
          this.loadingText.innerHTML = "Loading videos...";
          await this.loadVideos();
          
          this.loadingText.innerHTML = "Checking camera...";
          await this.checkCamera();
          
          this.loadingText.innerHTML = "Starting AR...";
          await this.initAR();
          
          // Only update the loading text if AR hasn't been initialized
          if (!this.arInitialized) {
            this.loadingText.innerHTML = "Looking for targets...";
          }
        } catch (error) {
          console.error('Initialization error:', error);
          this.showError(error.message);
        }
      }

      async loadVideos() {
        try {
          const loader1 = new VideoLoader(this.video1, 'assets/asset.mp4');
          const loader2 = new VideoLoader(this.video2, 'assets/asset2.mp4');
          
          await Promise.all([
            loader1.load(),
            loader2.load()
          ]);
        } catch (error) {
          throw new Error('Failed to load videos. Please check your connection and try again.');
        }
      }

      async checkCamera() {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ video: true });
          stream.getTracks().forEach(track => track.stop());
        } catch (error) {
          throw new Error('Camera access denied. Please allow camera access and refresh.');
        }
      }

      initAR() {
        return new Promise((resolve, reject) => {
          const playButton = document.getElementById("playButton");
          const videoPlane1 = document.querySelector('a-entity[target-index="1"] a-plane');
          const videoPlane2 = document.querySelector('a-entity[target-index="0"] a-plane');
          const sceneEl = document.querySelector('a-scene');

          // Add timeout for AR initialization
          const arTimeout = setTimeout(() => {
            if (!this.arInitialized) {
              reject(new Error('AR initialization timed out. Please refresh the page.'));
            }
          }, 30000); // 30 second timeout

          sceneEl.addEventListener('arReady', () => {
            console.log("AR System Ready");
            this.arInitialized = true;
            clearTimeout(arTimeout);
            this.loadingText.innerHTML = "Looking for targets...";
            resolve();
          });

          sceneEl.addEventListener('arError', (ev) => {
            console.error('AR Error:', ev);
            clearTimeout(arTimeout);
            reject(new Error("AR system error. Please refresh the page."));
          });

          [0, 1].forEach(targetIndex => {
            const targetEntity = document.querySelector(`a-entity[target-index="${targetIndex}"]`);
            
            targetEntity.addEventListener('targetFound', () => {
              console.log(`Target ${targetIndex} found`);
              this.loadingScreen.style.display = "none";
              this.targetDetected = true;
              
              this.currentVideo = targetIndex === 0 ? this.video2 : this.video1;
              this.currentPlane = targetIndex === 0 ? videoPlane2 : videoPlane1;
              
              this.pauseOtherVideos();
              
              if (!this.videoPlaying) {
                playButton.style.display = "flex";
              }
            });

            targetEntity.addEventListener('targetLost', () => {
              console.log(`Target ${targetIndex} lost`);
              if (this.currentVideo === (targetIndex === 0 ? this.video2 : this.video1)) {
                this.currentVideo.pause();
                this.currentVideo.currentTime = 0;
                this.currentVideo.muted = true;
                playButton.style.display = "none";
                this.targetDetected = false;
                this.currentPlane.setAttribute('visible', false);
              }
            });
          });

          this.setupVideoEventListeners(playButton);
        });
      }

      setupVideoEventListeners(playButton) {
        playButton.addEventListener("click", () => {
          if (this.targetDetected && this.currentVideo) {
            playButton.style.display = "none";
            this.currentPlane.setAttribute('visible', true);
            this.currentVideo.muted = false;
            
            this.currentVideo.play().catch(error => {
              console.error('Playback failed:', error);
              playButton.style.display = "flex";
            });
          }
        });

        [this.video1, this.video2].forEach(video => {
          video.addEventListener('play', () => {
            this.videoPlaying = true;
            this.pauseOtherVideos();
          });
          
          video.addEventListener('pause', () => {
            if (this.currentVideo === video) {
              this.videoPlaying = false;
            }
          });

          video.addEventListener('ended', () => {
            if (this.currentVideo === video) {
              this.videoPlaying = false;
              playButton.style.display = "flex";
            }
          });
        });
      }

      pauseOtherVideos() {
        [this.video1, this.video2].forEach(video => {
          if (video !== this.currentVideo) {
            video.pause();
            video.currentTime = 0;
            video.muted = true;
          }
        });
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      new ARExperience();
    });
  </script>
</head>
<body>
  <!-- ... rest of the HTML remains the same ... -->
</body>
</html>
